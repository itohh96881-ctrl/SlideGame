<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Shooter V2</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; touch-action: none; font-family: 'Arial', sans-serif; }
        canvas { display: block; margin: 0 auto; background-color: #1a1a1a; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #ui-layer { position: absolute; top: 10px; left: 10px; color: white; font-weight: bold; pointer-events: none; text-shadow: 1px 1px 2px black; }
        .hud-text { font-size: 18px; margin-bottom: 5px; }
        #game-over {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; text-align: center; display: none; background: rgba(0, 0, 0, 0.8);
            padding: 40px; border-radius: 10px; border: 2px solid #4CAF50;
        }
        button {
            padding: 15px 30px; font-size: 20px; cursor: pointer; background: #4CAF50;
            color: white; border: none; border-radius: 30px; margin-top: 20px;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); transition: 0.2s;
        }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="hud-text">SCORE: <span id="score">0</span></div>
    <div class="hud-text">LEVEL: <span id="level">1</span></div>
    <div class="hud-text" style="color: #00ff00;">WEAPON: <span id="weapon-level">SINGLE</span></div>
</div>

<div id="game-over">
    <h1 style="margin-top:0; color:#ff4444;">GAME OVER</h1>
    <p style="font-size:24px;">Score: <span id="final-score">0</span></p>
    <button onclick="resetGame()">RETRY</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // PCでは幅固定、スマホでは全幅
    function resize() {
        canvas.width = window.innerWidth > 500 ? 450 : window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // ゲーム変数
    let gameRunning = true;
    let score = 0;
    let level = 1;
    let frameCount = 0;
    
    // プレイヤー
    const player = {
        x: canvas.width / 2, y: canvas.height - 100, width: 40, height: 40,
        color: '#00BFFF', weaponLevel: 1 // 1:シングル, 2:トリプル, 3:ワイド
    };
    let targetX = player.x; // 操作目標位置

    // オブジェクト管理
    let bullets = [];
    let enemies = [];
    let particles = [];
    let items = [];

    // 操作
    function handleInput(e) {
        if (!gameRunning) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const rect = canvas.getBoundingClientRect();
        targetX = clientX - rect.left - player.width / 2;
    }
    window.addEventListener('mousemove', handleInput);
    window.addEventListener('touchmove', handleInput, { passive: false });

    // 爆発エフェクト生成
    function createExplosion(x, y, color) {
        for (let i = 0; i < 15; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 10,
                vy: (Math.random() - 0.5) * 10,
                life: 1.0, // 透明度
                color: color,
                size: Math.random() * 4 + 2
            });
        }
    }

    // ゲームループ
    function update() {
        if (!gameRunning) return;

        // 難易度調整
        level = 1 + Math.floor(score / 1000);
        document.getElementById('level').innerText = level;

        // プレイヤー移動
        player.x += (targetX - player.x) * 0.2;
        if (player.x < 0) player.x = 0;
        if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

        // 弾発射
        if (frameCount % 8 === 0) {
            spawnBullets();
        }

        // 敵出現（レベルが上がると頻度UP）
        const spawnRate = Math.max(20, 60 - level * 2);
        if (frameCount % spawnRate === 0) {
            const size = 30 + Math.random() * 20;
            enemies.push({
                x: Math.random() * (canvas.width - size),
                y: -size, width: size, height: size,
                hp: 1 + Math.floor(level / 2), // HPも増える
                speed: 2 + Math.random() * 2 + (level * 0.2)
            });
        }

        // アイテム出現（たまに）
        if (frameCount % 500 === 0) {
            items.push({
                x: Math.random() * (canvas.width - 30), y: -30, size: 20, speed: 3
            });
        }

        updateEntities();
        draw();
        frameCount++;
        requestAnimationFrame(update);
    }

    function spawnBullets() {
        const bSpeed = 12;
        // 基本弾
        bullets.push({x: player.x + player.width/2, y: player.y, vx: 0, vy: -bSpeed});
        
        // レベル2: 3WAY
        if (player.weaponLevel >= 2) {
            bullets.push({x: player.x + player.width/2, y: player.y, vx: -2, vy: -bSpeed * 0.9});
            bullets.push({x: player.x + player.width/2, y: player.y, vx: 2, vy: -bSpeed * 0.9});
        }
        // レベル3: 5WAY
        if (player.weaponLevel >= 3) {
            bullets.push({x: player.x + player.width/2, y: player.y, vx: -4, vy: -bSpeed * 0.8});
            bullets.push({x: player.x + player.width/2, y: player.y, vx: 4, vy: -bSpeed * 0.8});
        }
    }

    function updateEntities() {
        // 弾
        bullets.forEach((b, i) => {
            b.x += b.vx; b.y += b.vy;
            if (b.y < 0) bullets.splice(i, 1);
        });

        // パーティクル（爆発）
        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy;
            p.life -= 0.05;
            if (p.life <= 0) particles.splice(i, 1);
        });

        // アイテム
        items.forEach((item, i) => {
            item.y += item.speed;
            // プレイヤーとの衝突
            if (rectIntersect({x: item.x, y: item.y, width: item.size, height: item.size}, player)) {
                player.weaponLevel = Math.min(player.weaponLevel + 1, 3);
                updateWeaponText();
                items.splice(i, 1);
                score += 500;
            } else if (item.y > canvas.height) {
                items.splice(i, 1);
            }
        });

        // 敵
        enemies.forEach((e, i) => {
            e.y += e.speed;

            if (rectIntersect(player, e)) gameOver();

            bullets.forEach((b, j) => {
                // 弾と敵の当たり判定（簡易距離）
                if (Math.abs(b.x - (e.x + e.width/2)) < e.width/2 && Math.abs(b.y - (e.y + e.height/2)) < e.height/2) {
                    e.hp--;
                    bullets.splice(j, 1);
                    createExplosion(b.x, b.y, '#FFFF00'); // 小爆発
                    
                    if (e.hp <= 0) {
                        createExplosion(e.x + e.width/2, e.y + e.height/2, '#FF4444'); // 大爆発
                        enemies.splice(i, 1);
                        score += 100 + (level * 10);
                        document.getElementById('score').innerText = score;
                    }
                }
            });

            if (e.y > canvas.height) enemies.splice(i, 1);
        });
    }

    function draw() {
        ctx.fillStyle = '#111'; // 背景クリア（少し残像を残したければ透明度調整）
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // パーティクル
        particles.forEach(p => {
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();
        });
        ctx.globalAlpha = 1.0;

        // プレイヤー
        ctx.fillStyle = '#00BFFF';
        ctx.shadowBlur = 15; ctx.shadowColor = '#00BFFF'; // 光らせる
        ctx.fillRect(player.x, player.y, player.width, player.height);
        ctx.shadowBlur = 0;

        // 弾
        ctx.fillStyle = '#FFD700';
        bullets.forEach(b => {
            ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill();
        });

        // 敵
        enemies.forEach(e => {
            ctx.fillStyle = '#FF4444';
            ctx.fillRect(e.x, e.y, e.width, e.height);
            // HPが2以上なら文字で表示
            if(e.hp > 1) {
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.fillText(e.hp, e.x + e.width/2 - 4, e.y + e.height/2 + 4);
            }
        });

        // アイテム
        items.forEach(it => {
            ctx.fillStyle = '#00FF00';
            ctx.shadowBlur = 10; ctx.shadowColor = '#00FF00';
            ctx.beginPath(); ctx.arc(it.x + it.size/2, it.y + it.size/2, it.size/2, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;
            ctx.fillStyle = 'black'; ctx.font = '10px Arial';
            ctx.fillText('UP', it.x + 3, it.y + 14);
        });
    }

    function rectIntersect(r1, r2) {
        return !(r2.x > r1.x + r1.width || r2.x + r2.width < r1.x || r2.y > r1.y + r1.height || r2.y + r2.height < r1.y);
    }

    function updateWeaponText() {
        const texts = ['SINGLE', 'TRIPLE', 'MAX BURST'];
        document.getElementById('weapon-level').innerText = texts[player.weaponLevel - 1];
    }

    function gameOver() {
        gameRunning = false;
        document.getElementById('game-over').style.display = 'block';
        document.getElementById('final-score').innerText = score;
    }

    function resetGame() {
        score = 0; level = 1; frameCount = 0;
        player.weaponLevel = 1; updateWeaponText();
        player.x = canvas.width / 2 - 20; targetX = player.x;
        bullets = []; enemies = []; particles = []; items = [];
        document.getElementById('score').innerText = '0';
        document.getElementById('game-over').style.display = 'none';
        gameRunning = true;
        update();
    }
    
    update();
</script>
</body>
</html>
