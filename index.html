<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Flying Cat Shooter</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #ui {
            position: absolute; top: 10px; left: 10px; color: white;
            font-size: 20px; font-weight: bold; text-shadow: 1px 1px 2px black;
            pointer-events: none; z-index: 10;
        }
        #game-over {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; text-align: center; display: none; z-index: 20;
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; border: 2px solid #00BFFF;
        }
        button {
            padding: 10px 20px; font-size: 18px; cursor: pointer;
            background: #00BFFF; color: white; border: none; border-radius: 5px; margin-top: 10px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

<div id="ui">SCORE: <span id="score">0</span></div>
<div id="game-over">
    <h1>GAME OVER</h1>
    <p>Score: <span id="final-score">0</span></p>
    <button onclick="resetGame()">RETRY</button>
</div>

<script>
    // --- 基本設定 ---
    let scene, camera, renderer;
    let player, bullets = [], enemies = [], particles = [];
    let score = 0;
    let gameActive = true;
    let frame = 0;
    
    // マウス位置管理
    let targetX = 0;

    function init() {
        // シーン作成
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x111111, 0.02); // 奥行きの霧

        // カメラ
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 5, 10);
        camera.lookAt(0, 0, -5);

        // レンダラー
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x111111);
        document.body.appendChild(renderer.domElement);

        // ライト
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        // プレイヤー（黒猫）の作成
        createPlayer();

        // イベントリスナー
        window.addEventListener('resize', onWindowResize, false);
        document.addEventListener('mousemove', onMouseMove, false);
        document.addEventListener('touchmove', onTouchMove, { passive: false });

        animate();
    }

    // --- 3D黒猫の作成 ---
    function createPlayer() {
        player = new THREE.Group();

        // マテリアル
        const blackMat = new THREE.MeshLambertMaterial({ color: 0x222222 }); // 黒
        const eyeMat = new THREE.MeshBasicMaterial({ color: 0xFFFF00 }); // 黄色い目
        const wingMat = new THREE.MeshLambertMaterial({ color: 0x444444 }); // 暗いグレーの翼

        // 1. 体 (Capsuleっぽい形)
        const bodyGeo = new THREE.CylinderGeometry(0.5, 0.4, 1.2, 12);
        bodyGeo.rotateX(Math.PI / 2); // 横向きにする
        const body = new THREE.Mesh(bodyGeo, blackMat);
        player.add(body);

        // 2. 頭
        const headGeo = new THREE.SphereGeometry(0.45, 16, 16);
        const head = new THREE.Mesh(headGeo, blackMat);
        head.position.set(0, 0.3, -0.6);
        player.add(head);

        // 3. 耳 (円錐)
        const earGeo = new THREE.ConeGeometry(0.15, 0.3, 8);
        const earL = new THREE.Mesh(earGeo, blackMat);
        earL.position.set(-0.2, 0.3, -0.2);
        earL.rotation.set(-0.5, 0, -0.5);
        head.add(earL);

        const earR = new THREE.Mesh(earGeo, blackMat);
        earR.position.set(0.2, 0.3, -0.2);
        earR.rotation.set(-0.5, 0, 0.5);
        head.add(earR);

        // 4. 目
        const eyeGeo = new THREE.SphereGeometry(0.08, 8, 8);
        const eyeL = new THREE.Mesh(eyeGeo, eyeMat);
        eyeL.position.set(-0.15, 0.1, -0.35);
        head.add(eyeL);

        const eyeR = new THREE.Mesh(eyeGeo, eyeMat);
        eyeR.position.set(0.15, 0.1, -0.35);
        head.add(eyeR);

        // 5. 翼 (Boxを薄くして回転)
        const wingGeo = new THREE.BoxGeometry(1.2, 0.1, 0.6);
        
        // 左翼
        player.wingL = new THREE.Mesh(wingGeo, wingMat);
        player.wingL.position.set(-0.7, 0.2, 0);
        player.add(player.wingL);

        // 右翼
        player.wingR = new THREE.Mesh(wingGeo, wingMat);
        player.wingR.position.set(0.7, 0.2, 0);
        player.add(player.wingR);

        scene.add(player);
        player.position.y = 0;
        player.position.z = 0;
    }

    // --- 入力処理 ---
    function onMouseMove(event) {
        // マウス位置(-1 ~ 1)を計算
        const x = (event.clientX / window.innerWidth) * 2 - 1;
        // 3D空間の座標系にマッピング (左右幅10くらい)
        targetX = x * 8; 
    }

    function onTouchMove(event) {
        event.preventDefault();
        const x = (event.touches[0].clientX / window.innerWidth) * 2 - 1;
        targetX = x * 8;
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // --- ゲームループ ---
    function animate() {
        requestAnimationFrame(animate);

        if (!gameActive) return;

        frame++;

        // プレイヤー移動（滑らかに）
        player.position.x += (targetX - player.position.x) * 0.1;
        
        // プレイヤーのアニメーション（揺れと羽ばたき）
        player.rotation.z = (player.position.x - targetX) * -0.1; // 移動方向に傾く
        player.rotation.x = Math.sin(frame * 0.05) * 0.1; // 上下にふわふわ
        
        // 羽ばたき
        const flap = Math.sin(frame * 0.3) * 0.3;
        player.wingL.rotation.z = flap;
        player.wingR.rotation.z = -flap;

        // 弾の発射
        if (frame % 15 === 0) {
            createBullet();
        }

        // 敵の出現
        if (frame % 40 === 0) {
            createEnemy();
        }

        updateObjects();
        renderer.render(scene, camera);
    }

    function createBullet() {
        const geo = new THREE.SphereGeometry(0.2, 8, 8);
        const mat = new THREE.MeshBasicMaterial({ color: 0x00BFFF });
        const bullet = new THREE.Mesh(geo, mat);
        bullet.position.set(player.position.x, player.position.y, player.position.z - 1);
        scene.add(bullet);
        bullets.push(bullet);
    }

    function createEnemy() {
        const geo = new THREE.BoxGeometry(1, 1, 1);
        const mat = new THREE.MeshLambertMaterial({ color: 0xFF4444 });
        const enemy = new THREE.Mesh(geo, mat);
        enemy.position.set((Math.random() - 0.5) * 16, 0, -20); // 奥から出現
        scene.add(enemy);
        enemies.push(enemy);
    }

    function createExplosion(pos) {
        // 簡易パーティクル
        const particleCount = 8;
        const geo = new THREE.BoxGeometry(0.2, 0.2, 0.2);
        const mat = new THREE.MeshBasicMaterial({ color: 0xFFAA00 });
        
        for(let i=0; i<particleCount; i++) {
            const p = new THREE.Mesh(geo, mat);
            p.position.copy(pos);
            p.velocity = new THREE.Vector3(
                (Math.random()-0.5)*0.5,
                (Math.random()-0.5)*0.5,
                (Math.random()-0.5)*0.5
            );
            scene.add(p);
            particles.push(p);
        }
    }

    function updateObjects() {
        // 弾の移動
        for (let i = bullets.length - 1; i >= 0; i--) {
            bullets[i].position.z -= 0.5;
            if (bullets[i].position.z < -20) {
                scene.remove(bullets[i]);
                bullets.splice(i, 1);
            }
        }

        // 敵の移動
        for (let i = enemies.length - 1; i >= 0; i--) {
            enemies[i].position.z += 0.3; // 手前に来る
            
            // 回転演出
            enemies[i].rotation.x += 0.05;
            enemies[i].rotation.y += 0.05;

            // 当たり判定：弾 vs 敵
            let hit = false;
            for (let j = bullets.length - 1; j >= 0; j--) {
                const dist = bullets[j].position.distanceTo(enemies[i].position);
                if (dist < 1.0) {
                    createExplosion(enemies[i].position);
                    scene.remove(enemies[i]);
                    scene.remove(bullets[j]);
                    enemies.splice(i, 1);
                    bullets.splice(j, 1);
                    score += 100;
                    document.getElementById('score').innerText = score;
                    hit = true;
                    break;
                }
            }
            if (hit) continue;

            // 当たり判定：敵 vs プレイヤー
            const distPlayer = enemies[i].position.distanceTo(player.position);
            if (distPlayer < 1.2) {
                gameOver();
            }

            // 画面外へ消える
            if (enemies[i].position.z > 5) {
                scene.remove(enemies[i]);
                enemies.splice(i, 1);
            }
        }

        // パーティクル更新
        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].position.add(particles[i].velocity);
            particles[i].scale.multiplyScalar(0.9); // 小さくなる
            if (particles[i].scale.x < 0.01) {
                scene.remove(particles[i]);
                particles.splice(i, 1);
            }
        }
    }

    function gameOver() {
        gameActive = false;
        document.getElementById('game-over').style.display = 'block';
        document.getElementById('final-score').innerText = score;
    }

    function resetGame() {
        // リセット処理
        score = 0;
        document.getElementById('score').innerText = 0;
        document.getElementById('game-over').style.display = 'none';
        
        // 敵・弾・パーティクル全削除
        enemies.forEach(e => scene.remove(e));
        bullets.forEach(b => scene.remove(b));
        particles.forEach(p => scene.remove(p));
        enemies = [];
        bullets = [];
        particles = [];
        
        player.position.set(0, 0, 0);
        targetX = 0;
        gameActive = true;
        animate();
    }

    // 開始
    init();

</script>
</body>
</html>
