<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Crowd Runner 3D - Beyond</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #87CEEB;
            font-family: sans-serif;
            user-select: none;
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            pointer-events: none;
            z-index: 10;
            text-shadow: 2px 2px 0 #000;
        }

        #coin-ui {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #FFD700;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            z-index: 10;
        }

        #fever-bar-container {
            position: absolute;
            top: 100px;
            left: 10px;
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid white;
            border-radius: 10px;
            overflow: hidden;
        }

        #fever-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FF4500);
            transition: width 0.2s;
        }

        #fever-text {
            position: absolute;
            top: 70px;
            left: 10px;
            font-size: 24px;
            color: #FFD700;
            font-weight: bold;
            display: none;
            text-shadow: 0 0 10px red;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        #game-over,
        #start-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 20;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 4px solid #fff;
            min-width: 320px;
        }

        #game-over {
            display: none;
        }

        .btn {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            background: #FF4500;
            color: white;
            border: none;
            border-radius: 50px;
            margin: 10px;
            font-weight: bold;
            box-shadow: 0 4px 0 #b33100;
        }

        .btn:active {
            box-shadow: 0 2px 0 #b33100;
            transform: translateY(2px);
        }

        .buy-btn {
            font-size: 14px;
            padding: 5px 10px;
            background: #FFD700;
            color: #000;
            box-shadow: 0 2px 0 #B8860B;
        }

        .upgrade-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1,
        h2,
        h3 {
            margin: 10px 0;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>

<body>

    <div id="ui">
        <h2>Lvl <span id="level">1</span></h2>
        <div>üë• <span id="count">1</span></div>
        <div>üèπ <span id="count-archer">0</span> üõ°Ô∏è <span id="count-shield">0</span></div>
        <div>SCORE: <span id="score">0</span></div>
    </div>
    <div id="coin-ui">üí∞ <span id="coins">0</span></div>
    <div id="fever-text">FEVER MODE!!</div>
    <div id="fever-bar-container">
        <div id="fever-bar"></div>
    </div>

    <div id="start-screen">
        <h1>Crowd Runner<br>Ultimate</h1>
        <p>Tap to Start & Enable Sound</p>
        <button class="btn" onclick="startGame()">START</button>
    </div>

    <div id="game-over">
        <h1 id="result-title">GAME OVER</h1>
        <p>Score: <span id="final-score">0</span></p>
        <div id="shop-menu">
            <h3>Power Up Shop</h3>
            <div class="upgrade-item"><span>Start Units (Lv.<span id="lvl-start">1</span>)</span><button
                    class="btn buy-btn" onclick="buyUpgrade('start')">50G</button></div>
            <div class="upgrade-item"><span>Fever Time (Lv.<span id="lvl-fever">1</span>)</span><button
                    class="btn buy-btn" onclick="buyUpgrade('fever')">100G</button></div>
        </div>
        <button id="retry-btn" class="btn" onclick="nextAction()">RETRY</button>
    </div>

    <script>
        // --- Audio System ---
        const AudioSys = {
            ctx: null,
            bgmOscs: [],
            init: function () {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                this.playBGM();
            },
            playTone: function (freq, type, duration, vol = 0.1) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playCoin: function () { this.playTone(1200, 'square', 0.1, 0.1); setTimeout(() => this.playTone(1800, 'square', 0.2, 0.1), 100); },
            playGate: function (good) { if (good) this.playTone(880, 'sine', 0.3, 0.1); else this.playTone(200, 'sawtooth', 0.3, 0.1); },
            playDamage: function () { this.playTone(100, 'sawtooth', 0.2, 0.2); },
            playExplosion: function () {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(100, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(10, this.ctx.currentTime + 1);
                gain.gain.setValueAtTime(0.5, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 1);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 1);
            },
            playBGM: function () {
                if (!this.ctx) return;
                const melody = [330, 330, 392, 440, 330, 294, 262, 294]; // Á∞°Êòì„É°„É≠„Éá„Ç£
                let idx = 0;
                const playNote = () => {
                    if (!gameActive && bossState !== 'battling') return; // „Ç≤„Éº„É†‰∏≠„ÅÆ„Åø
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'triangle';
                    osc.frequency.value = melody[idx % melody.length] * (bossState === 'battling' ? 0.8 : 1.0); // „Éú„ÇπÊà¶„ÅØÂ∞ë„Åó‰Ωé„Åè
                    gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.2);
                    osc.connect(gain); gain.connect(this.ctx.destination);
                    osc.start(); osc.stop(this.ctx.currentTime + 0.2);
                    idx++;
                    setTimeout(playNote, 250);
                };
                playNote();
            }
        };

        // --- Game Constants & State ---
        let RUN_SPEED = 0.3;
        const LIMIT_X = 6;
        let GOAL_Z = 400;

        let savedData = { coins: 0, lvlStart: 1, lvlFever: 1 };
        let currentLevel = 1;
        let scene, camera, renderer;
        let soldiers = [];
        let crowdGroup;
        let score = 0;
        let gameActive = false; // Start screen first
        let frame = 0;
        let particles = [];
        let obstacles = [];
        let coinObjects = [];
        let projectiles = [];
        let soldierProjectiles = []; // ÂºìÂÖµ„ÅÆÁü¢

        let feverValue = 0;
        const FEVER_MAX = 100;
        let isFever = false;
        let feverTimer = 0;

        let bossMesh = null;
        let bossHP;
        let bossState = 'waiting';
        let bossAttackTimer = 0;
        let bossLaserMesh = null;
        let laserCharge = 0;

        let targetX = 0;

        const BIOMES = [
            { name: "GRASS", color: 0x3cb371, sky: 0x87CEEB, deco: 0x228B22 },
            { name: "DESERT", color: 0xE6C229, sky: 0xFFD700, deco: 0x8B4513 },
            { name: "SNOW", color: 0xE0FFFF, sky: 0xF0F8FF, deco: 0xA9A9A9 },
            { name: "LAVA", color: 0x8B0000, sky: 0x330000, deco: 0x000000 }
        ];
        let currentBiome = BIOMES[0];

        // --- Core Functions ---
        function loadData() {
            const d = localStorage.getItem('crowd_runner_save');
            if (d) savedData = JSON.parse(d);
            updateShopUI();
        }
        function saveData() { localStorage.setItem('crowd_runner_save', JSON.stringify(savedData)); updateShopUI(); }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            AudioSys.init();
            init();
            gameActive = true;

            // ÂàùÊúüÂÖµÂ£´ (Shop)
            for (let i = 0; i < savedData.lvlStart; i++) addSoldier('normal');
        }

        function init() {
            loadData();
            setupScene();
            setupGame();

            window.addEventListener('resize', onWindowResize, false);
            document.addEventListener('mousemove', onMouseMove, false);
            document.addEventListener('touchmove', onTouchMove, { passive: false });
            // Start animate loop if not running
            if (frame === 0) animate();
        }

        function setupScene() {
            scene = new THREE.Scene();
            updateBiomeColors();

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 8, -12);
            camera.lookAt(0, 0, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;

            const oldCanvas = document.querySelector('canvas');
            if (oldCanvas) oldCanvas.remove();
            document.body.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(-5, 10, -5); dirLight.castShadow = true;
            scene.add(dirLight);

            const groundGeo = new THREE.PlaneGeometry(30, 2000);
            const groundMat = new THREE.MeshLambertMaterial({ color: currentBiome.color });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2; ground.position.z = 500; ground.receiveShadow = true; ground.name = "ground";
            scene.add(ground);

            createDecorations();
        }

        function setupGame() {
            soldiers = []; particles = []; obstacles = []; coinObjects = []; projectiles = []; soldierProjectiles = []; gates = [];
            bossMesh = null; bossLaserMesh = null; bossState = 'waiting'; laserCharge = 0;

            frame = 1; // start
            crowdGroup = new THREE.Group();
            scene.add(crowdGroup);

            feverValue = 0; isFever = false;

            RUN_SPEED = 0.3 + (currentLevel * 0.05);
            GOAL_Z = 350 + (currentLevel * 50);
            bossHP = 100 + (currentLevel * 50); // HPÂ¢óÂä†

            createGoal();
            addSoldier('normal'); // ÂøÖ„Åö1‰∫∫„ÅØ„ÅÑ„Çã
        }

        function updateBiomeColors() {
            const idx = (currentLevel - 1) % BIOMES.length;
            currentBiome = BIOMES[idx];
            scene.background = new THREE.Color(currentBiome.sky);
            scene.fog = new THREE.Fog(currentBiome.sky, 10, 60);
            const ground = scene.getObjectByName("ground");
            if (ground) ground.material.color.setHex(currentBiome.color);
        }

        function createDecorations() {
            for (let z = 20; z < GOAL_Z; z += 30) {
                [-12, 12].forEach(x => {
                    if (Math.random() > 0.3) {
                        const size = Math.random() * 2 + 1;
                        const geo = new THREE.ConeGeometry(size, size * 2, 4);
                        const mat = new THREE.MeshLambertMaterial({ color: currentBiome.deco });
                        const mesh = new THREE.Mesh(geo, mat);
                        mesh.position.set(x + (Math.random() - 0.5) * 5, size, z + (Math.random() - 0.5) * 10);
                        scene.add(mesh);
                    }
                });
            }
        }

        // --- Soldier System ---
        // Types: normal, archer, shield
        function addSoldier(type = 'normal') {
            const s = createSoldierMesh(type);
            s.userData.type = type;
            s.userData.hp = 1;
            if (type === 'shield') s.userData.shield = true;

            soldiers.push(s);
            crowdGroup.add(s);
            createParticles(s.position.x, s.position.y, s.position.z + crowdGroup.position.z, 0x00FFFF, 5);
            updateFormation();
            updateUI();
            addFever(2);
        }

        function createSoldierMesh(type) {
            const group = new THREE.Group();
            // Color based on type or Fever
            let bodyColor = isFever ? 0xFFD700 : 0x1E90FF;
            let headColor = 0xFFD700;
            let hatColor = null;

            if (!isFever) {
                if (type === 'archer') { bodyColor = 0xFF6347; hatColor = 0x8B0000; } // Reddish
                if (type === 'shield') { bodyColor = 0x32CD32; hatColor = 0x006400; } // Greenish
            }

            const mat = new THREE.MeshLambertMaterial({ color: bodyColor });
            const bodyGeo = new THREE.CylinderGeometry(0.2, 0.2, 0.6, 8);
            const body = new THREE.Mesh(bodyGeo, mat);
            body.position.y = 0.5; group.add(body);

            const headMat = new THREE.MeshLambertMaterial({ color: headColor });
            const headGeo = new THREE.SphereGeometry(0.25, 8, 8);
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.y = 1.0; group.add(head);

            if (hatColor) {
                const hatGeo = new THREE.ConeGeometry(0.3, 0.3, 8);
                const hatMat = new THREE.MeshLambertMaterial({ color: hatColor });
                const hat = new THREE.Mesh(hatGeo, hatMat);
                hat.position.y = 1.3; group.add(hat);
            }

            // Ë£ÖÂÇôÂìÅ
            if (type === 'archer') {
                const bowGeo = new THREE.TorusGeometry(0.2, 0.02, 4, 8, Math.PI);
                const bow = new THREE.Mesh(bowGeo, new THREE.MeshBasicMaterial({ color: 0x8B4513 }));
                bow.position.set(0.2, 0.6, 0.1); bow.rotation.y = Math.PI / 2;
                group.add(bow);
            } else if (type === 'shield') {
                const shGeo = new THREE.BoxGeometry(0.4, 0.5, 0.05);
                const sh = new THREE.Mesh(shGeo, new THREE.MeshBasicMaterial({ color: 0xA9A9A9 }));
                sh.position.set(0, 0.6, 0.2);
                group.add(sh);
            }

            return group;
        }

        function updateFormation() {
            if (soldiers.length === 0) return;
            soldiers[0].position.set(0, 0, 0);
            let angle = 0;
            for (let i = 1; i < soldiers.length; i++) {
                angle += 1;
                const radius = 0.4 * Math.sqrt(i);
                const x = Math.cos(angle * 2.4) * radius;
                const z = Math.sin(angle * 2.4) * radius;
                soldiers[i].position.set(x, 0, z);
            }
        }

        // --- Actions ---
        function soldierAttack(s) {
            if (s.userData.type === 'archer') {
                // Áü¢„ÇíÊîæ„Å§
                if (Math.random() < 0.05) { // Á¢∫Áéá„ÅßÁô∫Â∞Ñ
                    const arrow = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.05, 0.6), new THREE.MeshBasicMaterial({ color: 0xFFFFFF }));
                    arrow.position.set(s.position.x + crowdGroup.position.x, 1, s.position.z + crowdGroup.position.z);
                    arrow.userData = { vel: new THREE.Vector3(0, 0.1, 1), from: 'player' };
                    scene.add(arrow);
                    soldierProjectiles.push(arrow);
                    AudioSys.playTone(600, 'triangle', 0.05, 0.05);
                }
            }
        }

        // --- Boss Logic ---
        function createBoss() {
            const group = new THREE.Group();
            group.position.set(0, 0, GOAL_Z + 15);
            const mat = new THREE.MeshLambertMaterial({ color: 0x4B0082 });
            const bossScalar = 1 + (currentLevel * 0.2);

            const body = new THREE.Mesh(new THREE.BoxGeometry(6, 12, 4), mat); body.position.y = 6; group.add(body);
            const head = new THREE.Mesh(new THREE.BoxGeometry(4, 4, 4), mat); head.position.y = 14; group.add(head);

            const eyeMat = new THREE.MeshBasicMaterial({ color: 0xFF0000 });
            const leftEye = new THREE.Mesh(new THREE.PlaneGeometry(1, 1), eyeMat); leftEye.position.set(-1, 14, 2.1); group.add(leftEye);
            const rightEye = new THREE.Mesh(new THREE.PlaneGeometry(1, 1), eyeMat); rightEye.position.set(1, 14, 2.1); group.add(rightEye);

            group.scale.setScalar(bossScalar);
            scene.add(group);
            bossMesh = group;
        }

        function updateBoss() {
            if (!bossMesh || bossState === 'dead') return;

            if (bossState === 'waiting') {
                bossMesh.position.y = Math.sin(frame * 0.05) * 1;
            }

            if (gameActive && crowdGroup.position.z > GOAL_Z - 5) {
                bossState = 'battling';
                bossAttackTimer++;

                // Laser Logic
                if (bossAttackTimer > 200 && laserCharge === 0) {
                    // start charging
                    laserCharge = 1;
                    AudioSys.playTone(100, 'sawtooth', 1.0, 0.3); // „ÉÅ„É£„Éº„Ç∏Èü≥
                }
                if (laserCharge > 0) {
                    updateBossLaser();
                } else if (bossAttackTimer % 100 === 0 && Math.random() < 0.5) {
                    bossRockAttack();
                }

                // Player Attack
                if (frame % 5 === 0 && soldiers.length > 0) {
                    const s = soldiers.pop();
                    crowdGroup.remove(s);
                    updateFormation(); updateUI();
                    createParticles(bossMesh.position.x + (Math.random() - 0.5) * 5, bossMesh.position.y + Math.random() * 10, bossMesh.position.z, 0xFFFF00, 10);
                    bossHP -= (isFever ? 10 : 5);
                    bossMesh.scale.multiplyScalar(0.995);
                    AudioSys.playDamage();
                    if (bossHP <= 0) bossDefeated();
                }

                // Archer Auto Attack
                soldiers.forEach(s => soldierAttack(s));

                if (soldiers.length === 0 && bossHP > 0) gameOver();
            }
        }

        function updateBossLaser() {
            laserCharge++;
            if (!bossLaserMesh) {
                const geo = new THREE.CylinderGeometry(0.1, 0.1, 40); // Charging beam
                const mat = new THREE.MeshBasicMaterial({ color: 0xFF0000, transparent: true, opacity: 0.5 });
                bossLaserMesh = new THREE.Mesh(geo, mat);
                bossLaserMesh.rotation.x = Math.PI / 2;
                bossLaserMesh.position.set(0, 5, -20);
                bossMesh.add(bossLaserMesh);
            }

            bossLaserMesh.scale.setScalar(1 + laserCharge * 0.1); // „ÉÅ„É£„Éº„Ç∏„ÅßÂ§™„Åè
            bossLaserMesh.material.opacity = 0.5 + Math.sin(laserCharge) * 0.2;

            if (laserCharge > 60) { // FIRE
                AudioSys.playExplosion();
                // ÂÖ®‰ΩìÊîªÊíÉÂà§ÂÆö
                // ÁõæÂÖµ„Åå„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const shieldIndex = soldiers.findIndex(s => s.userData.type === 'shield' && s.userData.shield);
                if (shieldIndex !== -1 && !isFever) {
                    // ÁõæÂÖµ„ÅåÈò≤„Åê
                    soldiers[shieldIndex].userData.shield = false; // ÁõæÊ∂àË≤ª
                    createParticles(bossMesh.position.x, 5, bossMesh.position.z - 10, 0x00FF00, 30); // „Ç¨„Éº„Éâ„Ç®„Éï„Çß„ÇØ„Éà
                } else if (!isFever) {
                    // „ÉÄ„É°„Éº„Ç∏
                    removeSoldier(Math.floor(soldiers.length / 2) + 1); // ÂçäÂ£ä
                    createParticles(0, 5, GOAL_Z, 0xFF0000, 50);
                }

                bossMesh.remove(bossLaserMesh);
                bossLaserMesh = null;
                laserCharge = 0;
                bossAttackTimer = 0;
            }
        }

        function bossRockAttack() {
            const rock = new THREE.Mesh(new THREE.SphereGeometry(1, 8, 8), new THREE.MeshLambertMaterial({ color: 0x555555 }));
            rock.position.copy(bossMesh.position); rock.position.y += 10;
            rock.userData = { vel: new THREE.Vector3((Math.random() - 0.5) * 2, 0, -1), type: 'enemy' };
            scene.add(rock); projectiles.push(rock);
        }

        function bossDefeated() {
            bossState = 'dead'; scene.remove(bossMesh);
            AudioSys.playExplosion();
            savedData.coins += 100; saveData();
            levelClear();
        }

        function updateProjectiles() {
            // Rocks
            for (let i = projectiles.length - 1; i >= 0; i--) {
                const p = projectiles[i];
                p.position.add(p.userData.vel);
                if (p.position.y < 0) { scene.remove(p); projectiles.splice(i, 1); continue; }
                if (p.position.z < crowdGroup.position.z + 2 && p.position.z > crowdGroup.position.z - 2) {
                    if (Math.abs(p.position.x - crowdGroup.position.x) < 2 && !isFever) {
                        removeSoldier(3); scene.remove(p); projectiles.splice(i, 1);
                    }
                }
            }
            // Soldier Arrows
            for (let i = soldierProjectiles.length - 1; i >= 0; i--) {
                const p = soldierProjectiles[i];
                p.position.add(p.userData.vel);
                if (p.position.z > GOAL_Z + 15) { // Boss hit
                    if (bossState === 'battling') {
                        bossHP -= 2;
                        createParticles(p.position.x, p.position.y, p.position.z, 0xFFFF00, 2);
                    }
                    scene.remove(p); soldierProjectiles.splice(i, 1);
                } else if (p.position.z > GOAL_Z + 50) {
                    scene.remove(p); soldierProjectiles.splice(i, 1);
                }
            }
        }

        // --- Fever & Particles (Standard functions) ---
        function addFever(amount) { if (isFever) return; feverValue += amount; if (feverValue >= FEVER_MAX) activateFever(); updateUI(); }
        function activateFever() { isFever = true; feverValue = FEVER_MAX; feverTimer = 300 + (savedData.lvlFever - 1) * 50; document.getElementById('fever-text').style.display = 'block'; RUN_SPEED *= 1.5; updateSoldierVisuals(); }
        function updateFever() {
            if (!isFever) return; feverTimer--; feverValue = (feverTimer / (300 + (savedData.lvlFever - 1) * 50)) * FEVER_MAX;
            if (feverTimer <= 0) { isFever = false; feverValue = 0; document.getElementById('fever-text').style.display = 'none'; RUN_SPEED /= 1.5; updateSoldierVisuals(); }
            updateUI();
        }
        function updateSoldierVisuals() {
            scene.remove(crowdGroup);
            crowdGroup = new THREE.Group();
            crowdGroup.position.copy(crowdGroup.position);
            scene.add(crowdGroup);
            // Rebuild meshes
            const oldSoldiers = soldiers;
            soldiers = [];
            oldSoldiers.forEach(old => {
                const s = createSoldierMesh(old.userData.type);
                s.userData = old.userData;
                s.position.copy(old.position);
                soldiers.push(s); crowdGroup.add(s);
            });
        }

        function createParticles(x, y, z, c, n) { for (let i = 0; i < n; i++) { const m = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.2), new THREE.MeshBasicMaterial({ color: c })); m.position.set(x, y, z); m.userData = { vel: new THREE.Vector3((Math.random() - 0.5) * 0.5, Math.random() * 0.5, (Math.random() - 0.5) * 0.5), life: 1 }; scene.add(m); particles.push(m); } }
        function updateParticles() { for (let i = particles.length - 1; i >= 0; i--) { const p = particles[i]; p.position.add(p.userData.vel); p.userData.life -= 0.05; p.scale.setScalar(p.userData.life); if (p.userData.life <= 0) { scene.remove(p); particles.splice(i, 1); } } }

        // --- Environment (Coins, Obstacles) ---
        function updateCoins() { coinObjects.forEach((c, i) => { c.rotation.y += 0.05; if (c.position.z < crowdGroup.position.z + 1 && c.position.z > crowdGroup.position.z - 1 && Math.abs(c.position.x - crowdGroup.position.x) < 3) { scene.remove(c); coinObjects.splice(i, 1); savedData.coins++; updateUI(); AudioSys.playCoin(); } }); }
        function createHammer(z) { const g = new THREE.Group(); g.position.set(0, 1.5, z); g.add(new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 4), new THREE.MeshLambertMaterial({ color: 0x888888 }))); const h = new THREE.Mesh(new THREE.BoxGeometry(8, 1, 1), new THREE.MeshLambertMaterial({ color: 0x333333 })); h.position.y = 1; g.add(h); g.userData = { type: 'hammer', speed: (Math.random() > 0.5 ? 0.05 : -0.05) * (1 + currentLevel * 0.1) }; scene.add(g); obstacles.push(g); }
        function updateObstacles() {
            obstacles.forEach((o, i) => {
                if (o.userData.type == 'hammer') o.rotation.z += o.userData.speed;
                if (o.position.z < crowdGroup.position.z + 2 && o.position.z > crowdGroup.position.z - 2) {
                    if (isFever) { scene.remove(o); obstacles.splice(i, 1); createParticles(o.position.x, 2, o.position.z, 0xFFA500, 20); AudioSys.playExplosion(); }
                    else if (Math.abs(o.rotation.z % Math.PI) < 0.5 || Math.abs(o.rotation.z % Math.PI) > 2.6) {
                        if (Math.random() < 0.1) removeSoldier(1);
                    }
                }
            });
        }

        // --- Gates ---
        function createGate(zPos) {
            // Randomly decide gate content (Archer/Shield/Math)
            const type = Math.random();
            let val1, val2;
            if (type < 0.1) { val1 = { op: 'type', val: 'archer' }; val2 = { op: 'type', val: 'shield' }; }
            else { val1 = getRandomGateValue(); val2 = getRandomGateValue(); }

            const g1 = createGateMesh(val1, -2.5, zPos);
            const g2 = createGateMesh(val2, 2.5, zPos);
            gates.push(g1, g2); scene.add(g1, g2);

            if (Math.random() < 0.4 + currentLevel * 0.1) createHammer(zPos + 20);
            for (let k = 0; k < 5; k++) {
                const c = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.1, 8), new THREE.MeshBasicMaterial({ color: 0xFFD700 }));
                c.rotation.z = Math.PI / 2; c.position.set((Math.random() - 0.5) * 8, 1, zPos + 10 + k * 2); scene.add(c); coinObjects.push(c);
            }
        }
        function getRandomGateValue() { const r = Math.random(); return r < 0.4 ? { op: '+', val: Math.floor(Math.random() * 10) + 5 } : r < 0.7 ? { op: 'x', val: 2 } : { op: '-', val: Math.floor(Math.random() * 5) + 2 }; }
        function createGateMesh(d, x, z) {
            const g = new THREE.Group(); g.position.set(x, 1.5, z);
            const good = (d.op === '+' || d.op === 'x' || d.op === 'type');
            const color = good ? 0x00BFFF : 0xFF4444;
            const box = new THREE.Mesh(new THREE.BoxGeometry(4.5, 3, 0.2), new THREE.MeshLambertMaterial({ color: color, transparent: true, opacity: 0.3 })); g.add(box);
            const txt = (d.op === 'type') ? d.val.toUpperCase() : `${d.op}${d.val}`;
            const can = document.createElement('canvas'); can.width = 256; can.height = 128;
            const ctx = can.getContext('2d'); ctx.fillStyle = good ? 'rgba(0,191,255,0.8)' : 'rgba(255,68,68,0.8)'; ctx.fillRect(0, 0, 256, 128);
            ctx.font = 'bold 60px Arial'; ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(txt, 128, 64);
            const tm = new THREE.Mesh(new THREE.PlaneGeometry(4, 2), new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(can), transparent: true })); tm.position.z = 0.11; g.add(tm);
            g.userData = { data: d, active: true }; return g;
        }
        function updateLevel() {
            const nextZ = (Math.floor(crowdGroup.position.z / 40) + 1) * 40;
            if (nextZ < GOAL_Z - 30 && (!gates.length || gates[gates.length - 1].position.z < nextZ)) createGate(nextZ + 20);
            gates.forEach(g => {
                if (g.userData.active && g.position.z < crowdGroup.position.z && Math.abs(g.position.x - crowdGroup.position.x) < 2.5) {
                    applyGate(g.userData.data); g.userData.active = false; g.visible = false; AudioSys.playGate(true);
                }
            });
        }
        function applyGate(d) {
            if (d.op === 'type') { for (let i = 0; i < 3; i++) addSoldier(d.val); }
            else {
                let n = soldiers.length, t = n;
                if (d.op === '+') t += d.val; else if (d.op === 'x') t *= d.val; else t -= d.val;
                t = Math.floor(t); if (t < 0) t = 0;
                const diff = t - n;
                if (diff > 0) for (let i = 0; i < diff; i++) addSoldier('normal');
                else removeSoldier(Math.abs(diff));
            }
        }

        function removeSoldier(n) {
            if (isFever) return;
            for (let i = 0; i < n; i++) {
                if (soldiers.length === 0) break;
                const s = soldiers.pop(); crowdGroup.remove(s);
                createParticles(s.position.x + crowdGroup.position.x, 0.5, s.position.z + crowdGroup.position.z, 0xFF0000, 5);
                AudioSys.playDamage();
            }
            updateFormation(); updateUI();
            if (soldiers.length === 0) gameOver();
        }

        function onMouseMove(e) { if (gameActive) targetX = -(e.clientX / window.innerWidth * 2 - 1) * LIMIT_X; }
        function onTouchMove(e) { if (gameActive) { e.preventDefault(); targetX = -(e.touches[0].clientX / window.innerWidth * 2 - 1) * LIMIT_X; } }
        function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerWidth); }

        function animate() {
            requestAnimationFrame(animate);
            if (!gameActive) return;
            frame++;

            if (bossState !== 'battling') { crowdGroup.position.z += RUN_SPEED; camera.position.z += RUN_SPEED; }
            crowdGroup.position.x += (targetX - crowdGroup.position.x) * 0.1;

            soldiers.forEach((s, i) => { s.position.y = Math.abs(Math.sin(frame * 0.2 + i)) * 0.2; s.rotation.y = Math.sin(frame * 0.1) * 0.2; });

            updateLevel(); updateParticles(); updateCoins(); updateObstacles(); updateProjectiles(); updateBoss(); updateFever();
            renderer.render(scene, camera);
        }

        function levelClear() { gameActive = false; document.getElementById('game-over').style.display = 'block'; document.getElementById('result-title').innerText = `LEVEL ${currentLevel} CLEARED!`; document.getElementById('retry-btn').innerText = "NEXT LEVEL"; document.getElementById('retry-btn').onclick = nextLevel; }
        function gameOver() { gameActive = false; document.getElementById('game-over').style.display = 'block'; document.getElementById('result-title').innerText = "GAME OVER"; document.getElementById('retry-btn').innerText = "RETRY"; document.getElementById('retry-btn').onclick = startGame; }
        function nextLevel() { currentLevel++; document.getElementById('game-over').style.display = 'none'; while (scene.children.length > 0) scene.remove(scene.children[0]); init(); gameActive = true; }
        function nextAction() { if (soldiers.length > 0) nextLevel(); else startGame(); }

        function updateUI() {
            document.getElementById('level').innerText = currentLevel;
            document.getElementById('count').innerText = soldiers.length;
            document.getElementById('count-archer').innerText = soldiers.filter(s => s.userData.type === 'archer').length;
            document.getElementById('count-shield').innerText = soldiers.filter(s => s.userData.type === 'shield').length;
            document.getElementById('score').innerText = Math.floor(crowdGroup.position.z);
            document.getElementById('coins').innerText = savedData.coins;
            document.getElementById('fever-bar').style.width = (feverValue / FEVER_MAX * 100) + '%';
        }
        function updateShopUI() { document.getElementById('coins').innerText = savedData.coins; document.getElementById('lvl-start').innerText = savedData.lvlStart; document.getElementById('lvl-fever').innerText = savedData.lvlFever; }
        function buyUpgrade(t) {
            let c = 0;
            if (t === 'start') { c = 50 * savedData.lvlStart; if (savedData.coins >= c) { savedData.coins -= c; savedData.lvlStart++; saveAndPlaySound(); } }
            if (t === 'fever') { c = 100 * savedData.lvlFever; if (savedData.coins >= c) { savedData.coins -= c; savedData.lvlFever++; saveAndPlaySound(); } }
        }
        function saveAndPlaySound() { saveData(); AudioSys.playCoin(); updateShopUI(); }

    </script>
</body>

</html>